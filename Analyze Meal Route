import express from "express";
import { protect } from "../middleware/authMiddleware.js";
import OpenAI from "openai";
import Meal from "../models/Meal.js";
import dotenv from "dotenv";

dotenv.config();

const router = express.Router();
// Initialize OpenAI client using the API key from .env
const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

// @route   POST /api/analyze
// @desc    Analyzes meal text using GPT-4o-mini and saves history
// @access  Private (requires token)
router.post("/analyze", protect, async (req, res) => {
  try {
    const { text } = req.body;
    
    if (!text) {
        return res.status(400).json({ message: "Meal text is required for analysis." });
    }

    // Detailed prompt for GPT-4o-mini to enforce structured JSON output
    const prompt = `
Analyze the following meal: "${text}"
Provide:
1. Estimated Calories (as a number, e.g., 550)
2. Protein, Carbs, Fats (as numbers, e.g., 30, 45, 15)
3. Health Rating (1-10, as a number, e.g., 7)
4. Short Advice (1-2 sentences)

Respond in JSON ONLY, using the following exact structure:
{
  "calories": 550,
  "protein": 30,
  "carbs": 45,
  "fats": 15,
  "healthRating": 7,
  "advice": "This is a balanced meal, ensure you drink enough water."
}
`;

    const completion = await openai.chat.completions.create({
      model: "gpt-4o-mini", // Using the efficient model as requested
      messages: [{ role: "user", content: prompt }],
      response_format: { type: "json_object" } // Enforce JSON response from the model
    });

    // The model should return a JSON string, which we parse
    const result = JSON.parse(completion.choices[0].message.content);

    // Save the analyzed meal to MongoDB
    const meal = await Meal.create({
      userId: req.user, // Set by the 'protect' middleware
      text,
      result
    });

    res.json({ saved: true, meal });

  } catch (err) {
    console.error("AI Analysis or Database Error:", err);
    // Return a generic error to the client
    res.status(500).json({ message: "AI analysis failed or server error occurred." });
  }
});

export default router;
